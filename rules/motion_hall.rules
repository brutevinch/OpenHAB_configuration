import org.openhab.core.library.types.*
import org.openhab.core.persistence.*
import org.openhab.model.script.actions.*
import org.openhab.core.types.*
import org.joda.time.*

var Timer tLightHall
var boolean from_state = false

rule "Свет в коридоре по датчику движения"
	when 
		Item SensorHallMotion received update
	then
		var DateTime light_to_off = now.plusSeconds(17)

		if(now.getHourOfDay >= 7 && now.getHourOfDay <= 10 || now.getHourOfDay >= 18 && now.getHourOfDay <= 22 || sNobodyhome.state == ON || from_state == true) {
			
			if(SensorHallMotion.state == ON){		
				sendCommand(LightHallMain, ON)
			   	if(tLightHall!=null) {
        		        	tLightHall.cancel() 
				}
	
				if(sNobodyhome.state == ON) {
					from_state = true
					sendNotification("brutevinch@icloud.com", "Обнаружено движение!")
					sendCommand(sNobodyhome, OFF)
				}
				
			} else {
			
				if(tLightHall!=null) {
            	tLightHall.cancel()
            	}
            
				if(LightHallMain.state == ON) {
					tLightHall = createTimer(light_to_off) [|
	            		if(LightHallMain.state == ON) {    
						sendCommand(LightHallMain, OFF)
						from_state = false 
						}
					]
				}
			}				
	end